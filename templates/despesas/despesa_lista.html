{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 fw-bold mb-0 text-brand-blue-900">Minhas Despesas</h1>
        <a class="btn btn-brand-green shadow-sm" href="{% url 'despesa_criar' %}">
            <i class="bi bi-plus-lg me-1"></i> Nova Despesa
        </a>
    </div>

    <div class="card border-0 shadow-sm mb-4 bg-light">
        <div class="card-body p-3">
            <form method="get" class="row g-2 align-items-center" id="filterForm">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" name="busca" class="form-control border-start-0 ps-0" 
                               placeholder="Buscar loja ou descrição..." value="{{ filtro_busca|default:'' }}">
                    </div>
                </div>
                <div class="col-md-2 col-4">
                    <select name="mes" class="form-select form-select-sm">
                        <option value="">Mês: Todos</option>
                        <option value="1" {% if filtro_mes == '1' %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if filtro_mes == '2' %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if filtro_mes == '3' %}selected{% endif %}>Março</option>
                        <option value="4" {% if filtro_mes == '4' %}selected{% endif %}>Abril</option>
                        <option value="5" {% if filtro_mes == '5' %}selected{% endif %}>Maio</option>
                        <option value="6" {% if filtro_mes == '6' %}selected{% endif %}>Junho</option>
                        <option value="7" {% if filtro_mes == '7' %}selected{% endif %}>Julho</option>
                        <option value="8" {% if filtro_mes == '8' %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if filtro_mes == '9' %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if filtro_mes == '10' %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if filtro_mes == '11' %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if filtro_mes == '12' %}selected{% endif %}>Dezembro</option>
                    </select>
                </div>
                <div class="col-md-2 col-4">
                    <select name="ano" class="form-select form-select-sm">
                        <option value="">Ano: Todos</option>
                        <option value="{{ hoje.year }}" {% if filtro_ano == hoje.year|stringformat:"i" %}selected{% endif %}>{{ hoje.year }}</option>
                        <option value="{{ hoje.year|add:'-1' }}" {% if filtro_ano == hoje.year|add:'-1'|stringformat:"i" %}selected{% endif %}>{{ hoje.year|add:"-1" }}</option>
                        {% for dt in anos_disponiveis %}
                            {% if dt.year != hoje.year and dt.year != hoje.year|add:"-1" %}
                                <option value="{{ dt.year }}" {% if filtro_ano == dt.year|stringformat:"i" %}selected{% endif %}>{{ dt.year }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 col-4">
                    <select name="pagamento" class="form-select form-select-sm">
                        <option value="">Pgto: Todos</option>
                        {% for codigo, nome in opcoes_pagamento %}
                        <option value="{{ codigo }}" {% if filtro_pagamento == codigo %}selected{% endif %}>{{ nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    {% if messages %}
    {% for m in messages %}
    <div class="alert alert-success py-2 mb-3 shadow-sm border-0">{{ m }}</div>
    {% endfor %}
    {% endif %}

    {% if despesas %}
        
        {% regroup despesas by data|date:"F Y" as despesas_por_mes %}

        <div class="accordion" id="accordionMeses">
            {% for mes_group in despesas_por_mes %}
            
            <div class="accordion-item border-0 shadow-sm mb-3 overflow-hidden rounded">
                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                    <button class="accordion-button fw-bold text-brand-blue-900 {% if not forloop.first %}collapsed{% endif %}" 
                            type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapseMes{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                            aria-controls="collapseMes{{ forloop.counter }}">
                        <i class="bi bi-calendar-event me-2"></i> {{ mes_group.grouper|capfirst }}
                        <span class="badge bg-primary-subtle text-primary ms-3 rounded-pill">{{ mes_group.list|length }} despesas</span>
                    </button>
                </h2>
                
                <div id="collapseMes{{ forloop.counter }}" 
                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                     aria-labelledby="heading{{ forloop.counter }}" 
                     data-bs-parent="#accordionMeses">
                    
                    <div class="accordion-body p-0 bg-light">
                        <div class="d-flex flex-column gap-2 p-3">
                            
                            {% for d in mes_group.list %}
                            <div class="card border shadow-none hover-shadow transition-all bg-white">
                                <div class="card-body p-0">
                                    <div class="p-3 d-flex align-items-center justify-content-between cursor-pointer" 
                                         data-bs-toggle="collapse" 
                                         data-bs-target="#collapseDespesa{{ d.pk }}" 
                                         aria-expanded="false">
                                        
                                        <div class="d-flex align-items-center gap-3" style="min-width: 80px;">
                                            <div class="text-center">
                                                <div class="fs-4 fw-bold text-dark lh-1">{{ d.data|date:"d" }}</div>
                                                <div class="small text-muted" style="font-size: 0.7rem;">{{ d.data|date:"D"|upper }}</div>
                                            </div>
                                        </div>

                                        <div class="flex-grow-1 px-2">
                                            <div class="fw-bold text-brand-blue-900 text-truncate">{{ d.emitente_nome }}</div>
                                            <div class="small text-muted d-flex align-items-center gap-2 flex-wrap">
                                                {% if d.categoria %}
                                                <span class="badge bg-light text-secondary border fw-normal">{{ d.categoria.nome }}</span>
                                                {% endif %}
                                                <span><i class="bi bi-credit-card me-1"></i>{{ d.get_forma_pagamento_display }}</span>
                                            </div>
                                        </div>

                                        <div class="text-end ps-2">
                                            <div class="fs-6 fw-bold text-success">R$ {{ d.valor|floatformat:2 }}</div>
                                            <div class="small text-muted"><i class="bi bi-chevron-down"></i></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="collapse border-top bg-secondary-subtle bg-opacity-10" id="collapseDespesa{{ d.pk }}">
                                    <div class="p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small fw-bold text-uppercase text-muted">Detalhes</span>
                                            <div class="btn-group">
                                                <a href="{% url 'despesa_editar' d.pk %}" class="btn btn-sm btn-light border"><i class="bi bi-pencil"></i></a>
                                                <button class="btn btn-sm btn-light border text-danger" data-bs-toggle="modal" data-bs-target="#modalDelete{{ d.pk }}"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>

                                        {% if d.itens.all %}
                                        <table class="table table-sm table-borderless small mb-0 bg-white rounded">
                                            <thead class="text-muted border-bottom">
                                                <tr><th class="ps-2">Item</th><th class="text-center">Qtd</th><th class="text-end pe-2">Total</th></tr>
                                            </thead>
                                            <tbody>
                                                {% for item in d.itens.all %}
                                                <tr>
                                                    <td class="ps-2">{{ item.nome }}</td>
                                                    <td class="text-center">{{ item.quantidade|floatformat:0 }}</td>
                                                    <td class="text-end pe-2 fw-semibold">R$ {{ item.valor_total|floatformat:2 }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% endif %}
                                        
                                        {% if d.observacoes %}
                                            <div class="small text-muted mt-2 fst-italic">{{ d.observacoes }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="modal fade" id="modalDelete{{ d.pk }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-sm modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body text-center p-4">
                                            <h6 class="mb-3">Excluir despesa?</h6>
                                            <p class="small text-muted mb-4">{{ d.emitente_nome }}<br>R$ {{ d.valor }}</p>
                                            <div class="d-flex justify-content-center gap-2">
                                                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                <form action="{% url 'despesa_deletar' d.pk %}" method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %} </div>
                    </div>
                </div>
            </div>
            {% endfor %} </div>

    {% else %}
        <div class="bg-brand-blue-50 rounded p-5 text-center">
            <i class="bi bi-search fs-1 text-brand-blue opacity-50"></i>
            <p class="mt-3 mb-3 fw-semibold text-brand-blue-900">Nenhuma despesa encontrada.</p>
            <a href="{% url 'listar_despesa' %}" class="btn btn-outline-primary btn-sm">Limpar Filtros</a>
        </div>
    {% endif %}
</section>

<script src="{% static 'js/despesa_lista.js' %}"></script>
{% endblock %}