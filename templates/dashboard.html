{% extends "base.html" %}
{% load static %}
{% block content %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<section class="py-5">
    <div class="container">
        
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-3">
            <div>
                <h2 class="fw-bold text-brand-blue-900 mb-0">Painel Financeiro</h2>
                <span class="text-muted">{{ mes_atual|date:"F Y" }}</span>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'listar_receitas' %}" class="btn btn-outline-primary">
                    <i class="bi bi-wallet2 me-1"></i> Ver Receitas
                </a>
                <a href="{% url 'listar_despesa' %}" class="btn btn-outline-danger">
                    <i class="bi bi-receipt me-1"></i> Ver Despesas
                </a>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 bg-light-subtle">
                    <div class="card-body p-4 position-relative">
                        <button type="button" class="btn btn-sm btn-link text-secondary position-absolute top-0 end-0 mt-2 me-2" 
                                data-bs-toggle="modal" data-bs-target="#modalLimites" title="Configurar Metas e Limites">
                            <i class="bi bi-gear-fill fs-5"></i>
                        </button>

                        <small class="text-muted fw-bold text-uppercase ls-1">Orçamento Disponível</small>
                        <h2 class="text-primary fw-bold mt-2 mb-0">R$ {{ total_disponivel|floatformat:2 }}</h2>
                        <div class="small text-muted mt-1" style="font-size: 0.75rem">
                            Meta: R$ {{ perfil.limite_mensal|floatformat:2 }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 hover-shadow transition-all">
                    <a href="{% url 'listar_despesa' %}?mes={{ mes_atual|date:'m' }}&ano={{ mes_atual|date:'Y' }}" class="text-decoration-none text-dark">
                        <div class="card-body p-4">
                            <small class="text-muted fw-bold text-uppercase ls-1">Total Gasto</small>
                            <h2 class="text-danger fw-bold mt-2 mb-2">R$ {{ total_gasto|floatformat:2 }}</h2>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-danger" style="width: {{ pct_orcamento|floatformat:0 }}%;"></div>
                            </div>
                            <small class="text-muted mt-2 d-block" style="font-size: 0.8rem">{{ pct_orcamento|floatformat:1 }}% da meta</small>
                        </div>
                    </a>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <small class="text-secondary fw-bold text-uppercase ls-1">Saldo Restante</small>
                        <h2 class="fw-bold mt-2 mb-0 {% if saldo >= 0 %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ saldo|floatformat:2 }}
                        </h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-6 d-flex flex-column gap-4">
                
                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_pizza">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePizza">
                                <i class="bi bi-pie-chart-fill me-2 text-primary"></i> Gastos por Categoria
                            </button>
                        </h2>
                        <div id="collapsePizza" class="accordion-collapse collapse" data-bs-parent="#acc_pizza">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-end p-2 pe-3 bg-white border-bottom">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="pizzaradio" id="pizza-global" onclick="toggleChart('chart-pizza', 'Global')">
                                        <label class="btn btn-outline-primary" for="pizza-global">Hist.</label>
                                        <input type="radio" class="btn-check" name="pizzaradio" id="pizza-mensal" checked onclick="toggleChart('chart-pizza', 'Mensal')">
                                        <label class="btn btn-outline-primary" for="pizza-mensal">Mês</label>
                                    </div>
                                </div>
                                {% if graficos.pizza_mes %}<div id="chart-pizza" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Sem dados.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_orc">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOrc">
                                <i class="bi bi-clipboard-data me-2 text-secondary"></i> Orçado x Realizado
                            </button>
                        </h2>
                        <div id="collapseOrc" class="accordion-collapse collapse" data-bs-parent="#acc_orc">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-end p-2 pe-3 bg-white border-bottom">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="orcradio" id="orc-global" onclick="toggleChart('chart-orc', 'Global')">
                                        <label class="btn btn-outline-primary" for="orc-global">Hist.</label>
                                        <input type="radio" class="btn-check" name="orcradio" id="orc-mensal" checked onclick="toggleChart('chart-orc', 'Mensal')">
                                        <label class="btn btn-outline-primary" for="orc-mensal">Mês</label>
                                    </div>
                                </div>
                                {% if graficos.orcado_realizado %}<div id="chart-orc" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Cadastre metas.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_sem">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSem">
                                <i class="bi bi-calendar-week me-2 text-warning"></i> Gastos por Dia da Semana
                            </button>
                        </h2>
                        <div id="collapseSem" class="accordion-collapse collapse" data-bs-parent="#acc_sem">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-end p-2 pe-3 bg-white border-bottom">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="semradio" id="sem-global" onclick="toggleChart('chart-semana', 'Global')">
                                        <label class="btn btn-outline-primary" for="sem-global">Hist.</label>
                                        <input type="radio" class="btn-check" name="semradio" id="sem-mensal" checked onclick="toggleChart('chart-semana', 'Mensal')">
                                        <label class="btn btn-outline-primary" for="sem-mensal">Mês</label>
                                    </div>
                                </div>
                                {% if graficos.dia_semana %}<div id="chart-semana" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Sem dados.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

            </div> <div class="col-lg-6 d-flex flex-column gap-4">

                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_comp">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComp">
                                <i class="bi bi-bar-chart-fill me-2 text-success"></i> Receita x Despesa x Investimento
                            </button>
                        </h2>
                        <div id="collapseComp" class="accordion-collapse collapse" data-bs-parent="#acc_comp">
                            <div class="accordion-body p-0">
                                {% if graficos.comparativo %}<div id="chart-comp" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Sem dados.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_top5">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTop5">
                                <i class="bi bi-list-ol me-2 text-info"></i> Top 5 Categorias
                            </button>
                        </h2>
                        <div id="collapseTop5" class="accordion-collapse collapse" data-bs-parent="#acc_top5">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-end p-2 pe-3 bg-white border-bottom">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="top5radio" id="top5-global" onclick="toggleChart('chart-top5', 'Global')">
                                        <label class="btn btn-outline-primary" for="top5-global">Hist.</label>
                                        <input type="radio" class="btn-check" name="top5radio" id="top5-mensal" checked onclick="toggleChart('chart-top5', 'Mensal')">
                                        <label class="btn btn-outline-primary" for="top5-mensal">Mês</label>
                                    </div>
                                </div>
                                {% if graficos.top5_cat %}<div id="chart-top5" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Sem dados.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion shadow-sm rounded overflow-hidden" id="acc_fixa">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold text-brand-blue-900 bg-white py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFixa">
                                <i class="bi bi-wallet2 me-2 text-danger"></i> Fixa vs Variável
                            </button>
                        </h2>
                        <div id="collapseFixa" class="accordion-collapse collapse" data-bs-parent="#acc_fixa">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-end p-2 pe-3 bg-white border-bottom">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="fixaradio" id="fixa-global" onclick="toggleChart('chart-tipo', 'Global')">
                                        <label class="btn btn-outline-primary" for="fixa-global">Hist.</label>
                                        <input type="radio" class="btn-check" name="fixaradio" id="fixa-mensal" checked onclick="toggleChart('chart-tipo', 'Mensal')">
                                        <label class="btn btn-outline-primary" for="fixa-mensal">Mês</label>
                                    </div>
                                </div>
                                {% if graficos.fixa_var %}<div id="chart-tipo" class="w-100"></div>{% else %}<p class="text-center text-muted py-4">Sem dados.</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

            </div> </div>
    </div>
</section>

<div class="modal fade" id="modalLimites" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light border-bottom-0">
                <h5 class="modal-title fw-bold text-brand-blue-900">Configurar Metas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'salvar_limites' %}" method="post">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-danger">
                            <i class="bi bi-shield-lock-fill me-1"></i> Teto Máximo (Hard Cap)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">R$</span>
                            {{ form_limites.limite_mensal }}
                        </div>
                        <div class="form-text small">Valor absoluto que você não deseja ultrapassar de jeito nenhum.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold text-warning">
                            <i class="bi bi-bell-fill me-1"></i> Alerta de Atenção (Soft Cap)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">R$</span>
                            {{ form_limites.limite_aviso }}
                        </div>
                        <div class="form-text small">Valor gatilho para começarmos a te avisar sobre gastos excessivos.</div>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-brand-green px-4">Salvar Metas</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% for key, json_data in graficos.items %}
<script id="d-{{ key }}" type="application/json">{{ json_data|safe }}</script>
{% endfor %}

<script src="{% static 'js/dashboard.js' %}"></script>

{% endblock %}