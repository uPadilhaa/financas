{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<div class="py-4 dashboard-page">
  <div class="container-fluid px-lg-5">

    <!-- Cabeçalho -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
      <div>
        <h1 class="h4 fw-bold mb-1 text-brand-blue-900">Visão geral</h1>
        <p class="text-muted small mb-0">
          Visão consolidada de {{ data_referencia|date:"F/Y" }}
        </p>
      </div>

      <div class="d-flex flex-column align-items-stretch align-items-lg-end gap-2">

        <!-- ALERTA ACIMA -->
        <div class="d-flex justify-content-lg-end">
          <button type="button"
                  class="btn btn-outline-light bg-white text-brand-blue-900 d-flex align-items-center gap-2"
                  data-bs-toggle="modal" data-bs-target="#modalLimites">
            <i class="bi bi-bell-fill text-warning"></i>
            <span>Alerta</span>
          </button>
        </div>

        <!-- BOTÕES DE MÊS ABAIXO -->
        <div class="btn-group btn-group-sm shadow-sm" role="group" aria-label="Mês">
            <a href="{% url 'dashboard' %}?scope=anterior{% if periodo_filtro %}&range={{ periodo_filtro }}{% endif %}"
                class="btn btn-outline-light bg-white text-brand-blue-900 {% if escopo_mes == 'anterior' %}active{% endif %}">
                Mês anterior
            </a>
            <a href="{% url 'dashboard' %}?scope=atual{% if periodo_filtro %}&range={{ periodo_filtro }}{% endif %}"
                class="btn btn-outline-light bg-white text-brand-blue-900 {% if escopo_mes == 'atual' %}active{% endif %}">
                Mês atual
            </a>
            <a href="{% url 'dashboard' %}?scope=proximo{% if periodo_filtro %}&range={{ periodo_filtro }}{% endif %}"
                class="btn btn-outline-light bg-white text-brand-blue-900 {% if escopo_mes == 'proximo' %}active{% endif %}">
                Próximo mês
            </a>
        </div>

      </div>
    </div>

    <div class="dashboard-container">
      <!-- Sidebar com KPIs -->
      <aside class="kpi-sidebar">
        <div class="kpi-card-vertical theme-income">
          <i class="bi bi-wallet2 kpi-icon-overlay"></i>
          <div class="kpi-label-v">Total Entradas</div>
          <div class="kpi-value-v">R$ {{ entradas_totais|floatformat:2 }}</div>
          <div class="kpi-subtext-v">
            {% if renda_extra > 0 %}+ R$ {{ renda_extra|floatformat:0 }} extras{% else %}Apenas fixo{% endif %}
          </div>
        </div>

        <div class="kpi-card-vertical theme-expense">
          <i class="bi bi-cart4 kpi-icon-overlay"></i>
          <div class="kpi-label-v">Total Saídas</div>
          <div class="kpi-value-v">R$ {{ saidas_totais|floatformat:2 }}</div>
          <div class="kpi-subtext-v">Mês selecionado</div>
        </div>

        <div class="kpi-card-vertical theme-invest">
          <i class="bi bi-graph-up-arrow kpi-icon-overlay"></i>
          <div class="kpi-label-v">Investimentos</div>
          <div class="kpi-value-v">R$ {{ investimentos_totais|floatformat:2 }}</div>
          <div class="kpi-subtext-v">Total acumulado no mês</div>
        </div>

        <div class="kpi-card-vertical theme-balance">
          <i class="bi bi-bank kpi-icon-overlay"></i>
          <div class="kpi-label-v">Saldo Disponível</div>
          <div class="kpi-value-v {% if saldo < 0 %}text-danger{% endif %}">
            R$ {{ saldo|floatformat:2 }}
          </div>
          <div class="kpi-subtext-v">Em caixa</div>
        </div>

        <div class="kpi-card-vertical" style="background: #475569; border-left-color: #cbd5e1;">
          <i class="bi bi-calendar-event kpi-icon-overlay"></i>
          <div class="kpi-label-v">Lançamentos Futuros</div>
          <div class="kpi-value-v">R$ {{ lancamentos_futuros|floatformat:2 }}</div>
          <div class="kpi-subtext-v">A vencer nos próximos meses</div>
        </div>
      </aside>

      <!-- Área de gráficos -->
      <main class="charts-area">

        <!-- Linha com evolução + investimentos x despesas % -->
        <div class="row g-3 mb-3">
            <div class="col-xl-7">
            <div class="chart-card h-100">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
                <div>
                    <h5 class="chart-title mb-0">Evolução de Despesas</h5>
                    <span class="text-muted small">{{ titulo_evo }}</span>
                </div>
                <div class="d-flex justify-content-start justify-content-md-end">
                    <div class="btn-group btn-group-filter" role="group" aria-label="Intervalo de meses">
                    <a href="?range=6m{% if escopo_mes != 'atual' %}&scope={{ escopo_mes }}{% endif %}"
                        class="btn btn-outline-secondary {% if periodo_filtro == '6m' %}active{% endif %}">
                        6 meses
                    </a>
                    <a href="?range=12m{% if escopo_mes != 'atual' %}&scope={{ escopo_mes }}{% endif %}"
                      class="btn btn-outline-secondary {% if periodo_filtro == '12m' %}active{% endif %}">
                        1 ano
                    </a>

                    <a href="?range=future{% if escopo_mes != 'atual' %}&scope={{ escopo_mes }}{% endif %}"
                        class="btn btn-outline-secondary {% if periodo_filtro == 'future' %}active{% endif %}">
                        Futuro
                    </a>
                    </div>
                </div>
                </div>
                <div id="chart-evo" class="chart-container"></div>
            </div>
            </div>

            <div class="col-xl-5">
            <div class="chart-card h-100">
                <h5 class="chart-title mb-0">Investimentos x Despesas (%)</h5>
                <p class="text-muted small mb-3">Proporção sobre o total de cada mês</p>
                <div id="chart-invest-desp" class="chart-container"></div>
            </div>
            </div>
        </div>

        <!-- Linha de gráficos menores -->
        <div class="row g-3">
            <div class="col-lg-4">
            <div class="chart-card h-100">
                <h5 class="chart-title mb-3">Distribuição (Categorias)</h5>
                <div id="chart-pizza" class="chart-container"></div>
            </div>
            </div>
            <div class="col-lg-4">
            <div class="chart-card h-100">
                <h5 class="chart-title mb-1">Top 5 Maiores Gastos</h5>
                <p class="text-muted small mb-3">Últimos 12 meses</p>
                <div id="chart-top5" class="chart-container"></div>
            </div>
            </div>
            <div class="col-lg-4">
            <div class="chart-card h-100">
                <h5 class="chart-title mb-3">Orçado vs Realizado</h5>
                <div id="chart-orc" class="chart-container"></div>
            </div>
            </div>
        </div>

      </main>
    </div>
  </div>
</div>

{% if graficos %}
<script id="d-evo" type="application/json">{{ graficos.evolucao_despesas|safe }}</script>
<script id="d-invest-desp" type="application/json">{{ graficos.invest_despesas_pct|safe }}</script>
<script id="d-pizza" type="application/json">{{ graficos.pizza_mes|safe }}</script>
<script id="d-top5" type="application/json">{{ graficos.top5_cat|safe }}</script>
<script id="d-orc" type="application/json">{{ graficos.orcado_realizado|safe }}</script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endif %}
{% include "includes/modal_limites.html" %}
{% endblock %}
